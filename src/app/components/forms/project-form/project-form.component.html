<div class="flex flex-col w-full mx-auto p-4 md:p-6">
  <!-- Loading state -->
  <div *ngIf="!isFormReady" class="flex flex-col items-center justify-center p-8">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
    <p class="text-surface-600">Carregando formulário...</p>
  </div>

  <!-- Form content -->
  <form [formGroup]="projectForm" (ngSubmit)="onSubmit()" class="flex flex-col" *ngIf="isFormReady" styleClass="rounded-none">

    <!-- Informações Básicas -->
    <p-card header="Informações Básicas" styleClass="rounded-b-none">
      <div class="flex flex-col md:flex-row gap-4">
        <div class="flex flex-col gap-2 flex-2">
          <label for="name" class="flex items-start font-semibold">
            <i class="pi pi-briefcase mr-2 text-primary"></i>
            Nome do Projeto *
          </label>
          <input
            pInputText
            id="name"
            type="text"
            formControlName="name"
            placeholder="Digite o nome do projeto"
            [class.ng-invalid]="projectForm.get('name')?.invalid && projectForm.get('name')?.touched"
          />
          <small
            class="p-error block"
            *ngIf="projectForm.get('name')?.invalid && projectForm.get('name')?.touched"
          >
            Nome é obrigatório e deve ter pelo menos 3 caracteres
          </small>
        </div>

        <div class="flex flex-col gap-2 flex-1">
          <label for="status" class="flex items-start font-semibold">
            <i class="pi pi-info-circle mr-2 text-primary"></i>
            Status
          </label>
          <p-select
            id="status"
            formControlName="status"
            [options]="statusOptions"
            placeholder="Selecione o status"
            class="w-full"
          ></p-select>
        </div>
      </div>

      <div class="flex flex-col gap-2 mt-4">
        <label for="summary" class="flex items-start font-semibold">
          <i class="pi pi-file-edit mr-2 text-primary"></i>
          Resumo *
        </label>
        <textarea
          pTextarea
          id="summary"
          formControlName="summary"
          placeholder="Breve descrição do projeto (mínimo 10 caracteres)"
          rows="3"
        ></textarea>
        <small
          class="p-error block"
          *ngIf="projectForm.get('summary')?.invalid && projectForm.get('summary')?.touched"
        >
          <span *ngIf="projectForm.get('summary')?.errors?.['required']">Resumo é obrigatório</span>
          <span *ngIf="projectForm.get('summary')?.errors?.['minlength']">Resumo deve ter pelo menos 10 caracteres</span>
        </small>
      </div>

      <div class="flex flex-col gap-2 mt-4">
        <label for="image" class="flex items-start font-semibold">
          <i class="pi pi-image mr-2 text-primary"></i>
          URL da Imagem
        </label>
        <input
          pInputText
          id="image"
          type="url"
          formControlName="image"
          placeholder="https://exemplo.com/imagem.jpg"
        />
      </div>
    </p-card>

    <p-card header="Descrição" styleClass="rounded-none">
      <p-tabs value="0" size="small" *ngIf="isBrowser">
        <div class="flex justify-between">
          <p-tablist class="flex">
            <p-tab value="0" class="p-2 text-sm">Editor</p-tab>
            <p-tab value="1" class="p-2 text-sm">Preview</p-tab>
          </p-tablist>
        </div>
        <p-tabpanels>
          <p-tabpanel value="0">
            <textarea
              pTextarea
              id="description"
              formControlName="description"
              placeholder="
                Descrição detalhada do projeto (suporta Markdown)
                # Título Principal
                ## Subtítulo
                **Texto em negrito**
                *Texto em itálico*
                - Lista com marcadores
                1. Lista numerada
                [Link](https://exemplo.com)
                ![Imagem](https://exemplo.com/imagem.jpg)
              "
              rows="12"
              class="w-full font-mono text-sm p-3  border border-surface-border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
            ></textarea>
            <small
              class="p-error block mt-2"
              *ngIf="projectForm.get('description')?.invalid && projectForm.get('description')?.touched"
            >
              Descrição é obrigatória e deve ter pelo menos 10 caracteres
            </small>
          </p-tabpanel>
          <p-tabpanel value="1">
            <div class="border border-surface-border rounded-lg p-4 min-h-[300px] bg-surface-card">
              <div
                class="prose prose-sm max-w-none"
                [innerHTML]="markdownPreview"
                *ngIf="markdownPreview"
              ></div>
              <div
                class="text-surface-500 italic text-center py-8"
                *ngIf="!markdownPreview"
              >
                Digite algo no editor para ver o preview...
              </div>
            </div>
        </p-tabpanel>
        </p-tabpanels>
      </p-tabs>

      <!-- Fallback para SSR -->
      <div *ngIf="!isBrowser" class="flex flex-col gap-2">
        <textarea
          pTextarea
          id="description"
          formControlName="description"
          placeholder="Descrição detalhada do projeto (suporta Markdown)"
          rows="6"
          class="w-full p-3 border border-surface-border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
        ></textarea>
        <small
          class="p-error block"
          *ngIf="projectForm.get('description')?.invalid && projectForm.get('description')?.touched"
        >
          Descrição é obrigatória e deve ter pelo menos 10 caracteres
        </small>
      </div>
    </p-card>

    <!-- Datas -->
    <p-card header="Datas do Projeto" styleClass="rounded-none">
      <div class="flex flex-col md:flex-row">
        <div class="flex flex-col gap-2 ">
          <label for="startDate" class="flex items-start font-semibold">
            <i class="pi pi-calendar-plus mr-2 mt-1 text-primary"></i>
            Data de Início
          </label>
          <p-datepicker
            id="startDate"
            formControlName="startDate"
            dateFormat="dd/mm/yy"
            placeholder="Selecione a data de início"
            class="w-full"
            icon="pi pi-calendar"
          ></p-datepicker>
        </div>
        <div class="flex flex-col gap-2 ml-12">
          <label for="expectedDate" class="flex items-start font-semibold">
            <i class="pi pi-calendar-times mr-2 mt-1 text-primary"></i>
            Data Prevista
          </label>
          <p-datepicker
            id="expectedDate"
            formControlName="expectedDate"
            dateFormat="dd/mm/yy"
            placeholder="Selecione a data prevista"
            class="w-full"
            icon="pi pi-calendar"
          ></p-datepicker>
        </div>
      </div>
    </p-card>

    <!-- Equipe (apenas na edição) -->
    <p-card header="Equipe do Projeto" *ngIf="isFormReady && isEditMode && isBrowser && projectForm && projectForm.get('team')" styleClass="rounded-none">
      <p-tabs value="0" size="small" >
        <div class="flex justify-center ">
          <p-tablist class="flex">
            <p-tab value="0" class="p-2 text-sm">Membros Atuais</p-tab>
            <p-tab value="1" class="p-2 text-sm">Solicitações Pendentes</p-tab>
          </p-tablist>
        </div>
        <!-- Aba: Membros Atuais -->
        <p-tabpanels>
          <p-tabpanel value="0">
            <div class="flex flex-col gap-4">
              <div class="flex justify-center items-center">
                <h4 class="text-lg font-semibold">Membros da Equipe ({{ teamArray.length }})</h4>
              </div>

              <!-- Team Card Component -->
              <app-team-card
                [team]="getTeamForCard()"
                mode="edit"
                [showHeader]="false"
                (removeMember)="onTeamCardRemoveMember($event)"
                (editMember)="onTeamCardEditMember($event)">
              </app-team-card>
            </div>
          </p-tabpanel>

          <!-- Aba: Solicitações Pendentes -->
          <p-tabpanel value="1">
            <div class="flex flex-col gap-4">
              <div class="flex justify-center items-center">
                <h4 class="text-lg font-semibold">Solicitações ({{ pendingRequests.length }})</h4>
              </div>

              <!-- Request Card Component -->
              <app-request-card
                [requests]="pendingRequests"
                [showHeader]="false"
                (acceptRequest)="onRequestCardAcceptRequest($event)"
                (rejectRequest)="onRequestCardRejectRequest($event)">
              </app-request-card>
            </div>
          </p-tabpanel>
        </p-tabpanels>
      </p-tabs>
    </p-card>

    <!-- Tags -->
    <p-card header="Tags do Projeto" *ngIf="isFormReady && projectForm && projectForm.get('tags')" styleClass="rounded-none">
      <div class="flex flex-col gap-6">
        <div class="flex flex-col gap-4">
                  <!-- Tecnologias/Ferramentas -->
        <div class="flex flex-col gap-2">
          <label class="flex items-center font-semibold">
            <i class="pi pi-cog mr-2 text-primary"></i>
            Tecnologias/Ferramentas
          </label>
          <p-multiSelect
            [options]="tagOptions['tecnologias/ferramentas']"
            placeholder="Selecione as tecnologias"
            class="w-full"
            optionLabel="label"
            optionValue="value"
            display="chip"
            [maxSelectedLabels]="10"
            (onChange)="onTecnologiasFerramentasChange($event)"
            formControlName="selectedTecnologiasFerramentas"
          ></p-multiSelect>
        </div>

        <!-- Assuntos (Temas do Projeto) -->
        <div class="flex flex-col gap-2">
          <label class="flex items-center font-semibold">
            <i class="pi pi-tags mr-2 text-primary"></i>
            Assuntos (Temas do Projeto)
          </label>
          <p-multiSelect
            [options]="tagOptions.assuntos"
            placeholder="Selecione os temas do projeto"
            class="w-full"
            optionLabel="label"
            optionValue="value"
            display="chip"
            [maxSelectedLabels]="5"
            (onChange)="onAssuntosChange($event)"
            formControlName="selectedAssuntos"
          ></p-multiSelect>
        </div>

          <!-- Tempo Estimado e Complexidade -->
          <div class="flex flex-col md:flex-row gap-4">
            <!-- Tempo Estimado -->
            <div class="flex flex-col gap-2 flex-1">
              <label class="flex items-start font-semibold">
                <i class="pi pi-clock mr-2 text-primary"></i>
                Tempo Estimado
              </label>
              <p-select
                [options]="tagOptions.tempoEstimado"
                placeholder="Selecione o tempo"
                class="w-full"
                optionLabel="label"
                optionValue="value"
                (onChange)="onTempoEstimadoChange($event)"
                formControlName="selectedTempoEstimado"
              ></p-select>
            </div>

            <!-- Complexidade -->
            <div class="flex flex-col gap-2 flex-1">
              <label class="flex items-start font-semibold">
                <i class="pi pi-cog mr-2 text-primary"></i>
                Complexidade
              </label>
              <p-select
                [options]="tagOptions.complexidade"
                placeholder="Selecione a complexidade"
                class="w-full"
                optionLabel="label"
                optionValue="value"
                (onChange)="onComplexidadeChange($event)"
                formControlName="selectedComplexidade"
              ></p-select>
            </div>
          </div>
        </div>

        <!-- Preview das tags selecionadas -->
        <div class="flex flex-col gap-3" *ngIf="getTagsArray().length > 0">
          <h5 class="font-semibold">Tags Selecionadas:</h5>
          <div class="flex flex-wrap gap-2">
            <p-tag
              *ngFor="let tag of getTagsArray().value; let i = index"
              [value]="tag.name"
              [style]="{'background-color': tag.color}"
            ></p-tag>
          </div>
        </div>
      </div>
    </p-card>

    <!-- Vagas Não Preenchidas -->
    <p-card header="Vagas Não Preenchidas" *ngIf="isFormReady && isBrowser && projectForm && projectForm.get('unfilledRoles')" styleClass="rounded-t-none">
              <div class="flex flex-col gap-4">
        <div class="flex flex-col gap-2">
          <label class="flex items-center font-semibold">
            <i class="pi pi-users mr-2 text-primary"></i>
            Vagas Necessárias
          </label>
          <p-multiSelect
            formControlName="unfilledRoles"
            [options]="roleOptions"
            placeholder="Selecione as vagas necessárias"
            class="w-full"
            optionLabel="label"
            optionValue="value"
            display="chip"
            [maxSelectedLabels]="8"
          ></p-multiSelect>
        </div>

        <div class="text-sm text-surface-600">
          <p>Selecione as vagas que ainda precisam ser preenchidas para o projeto (máximo 8 vagas).</p>
        </div>

        <small
          class="p-error block"
          *ngIf="projectForm.get('unfilledRoles')?.errors?.['maxItems']"
        >
          Máximo de 8 vagas permitidas. Você selecionou {{ projectForm.get('unfilledRoles')?.errors?.['maxItems']?.actual }} vagas.
        </small>
      </div>
    </p-card>

    <!-- Fallback para SSR - Equipe -->
    <p-card header="Equipe do Projeto" *ngIf="isEditMode && !isBrowser">
      <div class="flex flex-col items-center justify-center p-8 text-surface-600 bg-surface-ground border-2 border-dashed border-surface-border rounded-lg">
        <p class="italic">Gerenciamento de equipe disponível apenas no navegador.</p>
      </div>
    </p-card>

    <!-- Fallback para SSR - Vagas -->
    <p-card header="Vagas Não Preenchidas" *ngIf="!isBrowser">
      <div class="flex flex-col items-center justify-center p-8 text-surface-600 bg-surface-ground border-2 border-dashed border-surface-border rounded-lg">
        <p class="italic">Seleção de vagas disponível apenas no navegador.</p>
      </div>
    </p-card>

    <!-- Ações -->
    <div class="flex justify-end gap-3 pt-6">
      <p-button
        label="Cancelar"
        severity="secondary"
        (onClick)="onCancel()"
      ></p-button>
      <p-button
        type="submit"
        [label]="isEditMode ? 'Atualizar Projeto' : 'Criar Projeto'"
        [icon]="isEditMode ? 'pi pi-check' : 'pi pi-plus'"
        [disabled]="projectForm.invalid"
      ></p-button>
    </div>
  </form>
</div>
